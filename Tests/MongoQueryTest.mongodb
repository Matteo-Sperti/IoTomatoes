// MongoDB Playground
// To disable this template go to Settings | MongoDB | Use Default Template For Playground.
// Make sure you are connected to enable completions and to be able to run a playground.
// Use Ctrl+Space inside a snippet or a string literal to trigger completions.

// Select the database to use.
use('PatataNovella');

// Select the collection to use.
var collection = db.getCollection('2');

var start = 1577836800.0;
var end = 2000000000.0;
var measure = "temperature";
var current_time = 1676626432.0;
MAX_TIME = 3600.0;

// Run the aggregation and open a cursor to the results.
// Use toArray() to exhaust the cursor to return the whole result set.
// You can use hasNext()/next() to iterate through the cursor page by page.
//Define the number of buckets
var num_buckets = 5

res = collection.aggregate([
    {"$match": {"e.n": measure, "e.t": {"$gte": start, "$lte": end}}},
    {"$unwind": "$e"},
    {"$match": {"e.n": measure, "e.t": {"$gte": start, "$lte": end}}},
    {"$sort": {"e.t": -1}},
    {"$project": {
        "_id": 0,
        "v": "$e.v",
        "u": "$e.u",
        "t": "$e.t"
    }},
    {
        "$bucketAuto": {
        "groupBy": "$t",
        "buckets": num_buckets,
        "output": {
            "v": {"$avg": "$v"},
            "u": {"$first": "$u"},
            "t": {"$avg": "$t"}
        }
    }},
    {"$group": {
        "_id": null,
        "v": {"$push": "$v"},
        "t": {"$push": "$t"},
        "u": {"$first": "$u"}
    }},
    {"$project": {
        "_id": 0,
        "v": 1,
        "t": 1,
        "u": 1
    }}
])
